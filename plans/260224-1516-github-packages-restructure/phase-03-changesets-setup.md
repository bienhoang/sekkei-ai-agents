# Phase 3: Changesets Setup

## Context Links
- [Plan Overview](./plan.md)
- [Phase 2 — Turborepo](./phase-02-turborepo-setup.md)
- [Root package.json](../../package.json)

## Overview
- **Priority**: P2
- **Status**: pending
- **Effort**: 30m
- **Depends on**: Phase 1 (scoped names needed in changeset config)

Add `@changesets/cli` for PR-based version management and changelog generation. Changesets is monorepo-aware — each PR can bump one or more packages independently.

## Key Insights
- Current release: manual tag push (`v*`) triggers `publish.yml` — no changelog, no independent versioning
- Changesets workflow: developer runs `npx changeset` → commits `.changeset/*.md` file → merge to main → Changesets bot opens "Version Packages" PR → merge that PR → auto-publish
- `@changesets/changelog-github` generates changelogs with PR links and author attribution
- `access: restricted` matches GitHub Packages private distribution
- `commit: false` — changesets doesn't auto-commit version bumps (the Version PR handles this)

## Requirements

### Functional
- `@changesets/cli` and `@changesets/changelog-github` installed as root devDependencies
- `.changeset/config.json` configured for GitHub Packages + restricted access
- Root `package.json` has `changeset` and `changeset:version` scripts

### Non-Functional
- `npx changeset` interactive prompt works
- `npx changeset version` bumps correct packages and generates `CHANGELOG.md`

## Related Code Files

| File | Change |
|------|--------|
| `package.json` (root) | Add devDependencies + scripts |
| `.changeset/config.json` | **New file** — changesets config |
| `.changeset/README.md` | **New file** — auto-generated by `changeset init` |

## Implementation Steps

### Step 1: Install Changesets

```bash
npm install -D @changesets/cli @changesets/changelog-github
```

### Step 2: Initialize Changesets

```bash
npx changeset init
```

This creates `.changeset/` directory with `config.json` and `README.md`.

### Step 3: Configure `.changeset/config.json`

**Replace** the auto-generated config with:

```json
{
  "$schema": "https://github.com/changesets/changesets/blob/main/packages/config/schema.json",
  "changelog": [
    "@changesets/changelog-github",
    { "repo": "bienhoang/sekkei-ai-agents" }
  ],
  "commit": false,
  "fixed": [],
  "linked": [],
  "access": "restricted",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
```

Config rationale:
- `changelog`: GitHub-flavored changelogs with PR links
- `commit: false`: version bumps happen in the auto-generated Version PR, not as separate commits
- `fixed: []`: no fixed versioning groups — packages version independently
- `linked: []`: no linked versioning — each package has its own semver
- `access: restricted`: GitHub Packages private
- `baseBranch: "main"`: release branch
- `updateInternalDependencies: "patch"`: if packages depend on each other, bump dependents

### Step 4: Add scripts to root `package.json`

Add to `"scripts"`:

```json
{
  "scripts": {
    "changeset": "changeset",
    "changeset:version": "changeset version",
    "changeset:publish": "changeset publish"
  }
}
```

These are convenience shortcuts — CI will call them directly.

### Step 5: Verify

```bash
# Interactive — creates a .changeset/*.md file
npx changeset
# Select package(s), bump type (patch/minor/major), description

# Dry-run version bump
npx changeset version
# Check that CHANGELOG.md appears in affected package(s)
# Then git checkout to undo (this was just a test)
git checkout -- .
```

## Developer Workflow (Post-Setup)

```
1. Make code changes on feature branch
2. Run `npx changeset` → select packages → describe change
3. Commit the .changeset/*.md file with your code
4. Open PR → CI runs build+test
5. Merge PR to main
6. Changesets GitHub Action opens "Version Packages" PR
7. Review + merge Version PR → auto-publish to GitHub Packages
```

## Todo List

- [ ] `npm install -D @changesets/cli @changesets/changelog-github`
- [ ] `npx changeset init`
- [ ] Replace `.changeset/config.json` with project config
- [ ] Add `changeset`, `changeset:version`, `changeset:publish` scripts to root `package.json`
- [ ] Verify `npx changeset` interactive prompt works
- [ ] Verify `npx changeset version` generates CHANGELOG.md

## Success Criteria

- `.changeset/config.json` exists with correct `access: restricted` and GitHub repo
- `npx changeset` opens interactive selector showing all 3 `@bienhoang/*` packages
- `npx changeset version` bumps versions and writes `CHANGELOG.md` entries
- `npx changeset publish --dry-run` targets `npm.pkg.github.com`

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Changesets learning curve | Low | Simple CLI — one command per PR |
| Forgot to run `npx changeset` | Low | CI can warn if PR has no changeset file |
| Version PR conflicts | Low | Changesets handles rebasing automatically |

## Security Considerations
- `.changeset/config.json` contains no secrets — safe to commit
- Publish step (Phase 4) uses `GITHUB_TOKEN` — no additional secrets needed

## Next Steps
- Phase 4 (CI/CD) uses `changeset version` and `changeset publish` in release workflow
